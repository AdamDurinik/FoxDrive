@{
    ViewData["Title"] = "FoxDen ‚Äì Todo";
}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>@ViewData["Title"]</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
  <style>
    .groups { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px; }
    .group { border:1px solid var(--line); border-radius:12px; padding:10px; background:var(--card-bg,#111); display:flex; flex-direction:column; }
    .group.done { opacity:.6; text-decoration:line-through; }
    .group-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .tasks{display:flex;flex-direction:column;gap:6px; min-height:120px;}
    .tasks.drop-target{ outline:2px dashed var(--accent); outline-offset:-6px; border-radius:8px; }
    .task{
      display:flex;justify-content:space-between;align-items:flex-start;
      padding:8px 10px;border:1px solid var(--line);border-radius:6px;background:var(--panel,#0f0f0f);
      min-height:100px; /* doubled, as requested */
      cursor:grab;
    }
    .task.dragging{ opacity:.55; transform:scale(.98); }
    .task.done{opacity:.6;text-decoration:line-through;}
    .add-form{display:flex;gap:6px;margin-top:6px;}
    .add-form input{flex:1;}
    .add-group{border:2px dashed var(--line);border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;min-height:140px;font-size:32px;}
    .bar{display:flex;justify-content:space-between;align-items:center;margin:8px 0;}
    .bar-left,.bar-right{display:flex;gap:8px;align-items:center;}
  </style>
</head>
<body>

<header>
    <div style="font-weight:600; display:flex; align-items:center; gap:6px;">
        <span>FoxDen</span>
        @if (User?.Identity?.IsAuthenticated ?? false)
        {
            <span class="brand-user">@User.Identity!.Name</span>
        }
    </div>

    <div class="header-actions">
      <a class="btn" href="/">Home</a>
      <form id="logoutForm" asp-controller="Auth" asp-action="Logout" method="post">
        @Html.AntiForgeryToken()
        <button type="submit" class="btn danger">Logout</button>
      </form>
    </div>
</header>

<main class="mt-16">
  <div class="card">
    <div class="title">Todo Groups</div>

    <div class="bar">
      <div class="bar-left">
        <input id="search" placeholder="Filter‚Ä¶ (/)" style="max-width:260px"/>
      </div>
      <div class="bar-right"></div>
    </div>

    <div id="groups" class="groups">
      <div id="addGroup" class="add-group" title="Add new group">+</div>
    </div>
  </div>
</main>

<script>
// ---------- helpers ----------
function antiForgery(){
  const f=document.querySelector('#logoutForm input[name="__RequestVerificationToken"]');
  return f?f.value:'';
}

// ---------- API (Todo) ----------
async function apiGet(){const r=await fetch('/api/todo',{cache:'no-store'});if(!r.ok)throw new Error(await r.text());return r.json();}
async function apiCreateGroup(name){const r=await fetch('/api/todo/group',{method:'POST',headers:{'Content-Type':'application/json','RequestVerificationToken':antiForgery()},body:JSON.stringify({name})});if(!r.ok)throw new Error(await r.text());}
async function apiToggleGroup(id){const r=await fetch(`/api/todo/group/${id}/toggle`,{method:'POST',headers:{'RequestVerificationToken':antiForgery()}});if(!r.ok)throw new Error(await r.text());}
async function apiDeleteGroup(id){const r=await fetch(`/api/todo/group/${id}`,{method:'DELETE',headers:{'RequestVerificationToken':antiForgery()}});if(!r.ok)throw new Error(await r.text());}
async function apiCreateItem(gid,text){const r=await fetch('/api/todo/item',{method:'POST',headers:{'Content-Type':'application/json','RequestVerificationToken':antiForgery()},body:JSON.stringify({groupId:gid,text})});if(!r.ok)throw new Error(await r.text());}
async function apiToggleItem(id){const r=await fetch(`/api/todo/item/${id}/toggle`,{method:'POST',headers:{'RequestVerificationToken':antiForgery()}});if(!r.ok)throw new Error(await r.text());}
async function apiDeleteItem(id){const r=await fetch(`/api/todo/item/${id}`,{method:'DELETE',headers:{'RequestVerificationToken':antiForgery()}});if(!r.ok)throw new Error(await r.text());}
async function apiUpdateItem(id, patch){const r=await fetch(`/api/todo/item/${id}`,{method:'PUT',headers:{'Content-Type':'application/json','RequestVerificationToken':antiForgery()},body:JSON.stringify(patch)});if(!r.ok)throw new Error(await r.text());}

// ---------- DOM/state ----------
const wrap=document.getElementById('groups'), addBtn=document.getElementById('addGroup');
const search=document.getElementById('search');
let draggingId = null;

function renderGroup(g){
  const div=document.createElement('div');
  div.className='group'+(g.done?' done':'');
  div.dataset.id=g.id;

  // list body (drop zone)
  const items = g.items
    .filter(t=>{
      const q=(search.value||'').trim().toLowerCase();
      if(!q) return true;
      return (t.text||'').toLowerCase().includes(q);
    });

  div.innerHTML=`
    <div class="group-header">
      <div>${g.name} <span class="muted small">(${g.items.filter(x=>!x.done).length}/${g.items.length})</span></div>
      <div>
        <button class="btn icon ${g.done?'':'primary'}" data-act="toggle-group">${g.done?'‚Ü©Ô∏è':'‚úîÔ∏è'}</button>
        <button class="btn icon danger" data-act="del-group">üóëÔ∏è</button>
      </div>
    </div>
    <div class="tasks" data-dropzone></div>
    <form class="add-form" data-act="add-item">
      <input name="text" placeholder="Add todo..." autocomplete="off"/>
      <button class="btn primary" type="submit">Add</button>
    </form>`;

  const zone = div.querySelector('[data-dropzone]');

  // render tasks
  for(const t of items){
    const row = document.createElement('div');
    row.className = 'task'+(t.done?' done':'');
    row.dataset.task = t.id;
    row.draggable = true;
    row.innerHTML = `
      <span style="padding-right:10px;word-break:break-word;white-space:pre-wrap;">${t.text}</span>
      <div>
        <button class="btn icon ${t.done?'':'primary'}" data-act="toggle-task">${t.done?'‚Ü©Ô∏è':'‚úîÔ∏è'}</button>
        <button class="btn icon danger" data-act="del-task">üóëÔ∏è</button>
      </div>`;

    // DnD ‚Äî start/end
    row.addEventListener('dragstart', ()=>{ draggingId = t.id; row.classList.add('dragging'); });
    row.addEventListener('dragend',   ()=>{ draggingId = null;  row.classList.remove('dragging'); });

    zone.appendChild(row);
  }

  // DnD ‚Äî dropzone handlers
  zone.addEventListener('dragover', (e)=>{ e.preventDefault(); zone.classList.add('drop-target'); });
  zone.addEventListener('dragleave', ()=> zone.classList.remove('drop-target'));
  zone.addEventListener('drop', async (e)=>{
    e.preventDefault(); zone.classList.remove('drop-target');
    if(!draggingId) return;
    await apiUpdateItem(draggingId, { groupId: g.id });
    await render();
  });

  return div;
}

async function render(){
  const data=await apiGet();
  wrap.querySelectorAll('.group').forEach(e=>e.remove());
  for(const g of data){
    wrap.insertBefore(renderGroup(g),addBtn);
  }
}

// add group
addBtn.onclick=async()=>{
  const name=prompt('Group name:');
  if(!name)return;
  await apiCreateGroup(name.trim());
  render();
};

// clicks (toggle/delete)
wrap.addEventListener('click',async e=>{
  const btn=e.target.closest('button[data-act]');
  if(!btn)return;
  const act=btn.dataset.act;
  const group=btn.closest('.group');
  const gid=parseInt(group?.dataset.id||'0',10);

  if(act==='toggle-group'){await apiToggleGroup(gid);render();return;}
  if(act==='del-group'){if(confirm('Delete group and all todos?')){await apiDeleteGroup(gid);render();}return;}

  const taskEl=btn.closest('.task');
  if(act==='toggle-task'){const tid=taskEl.dataset.task;await apiToggleItem(tid);render();return;}
  if(act==='del-task'){const tid=taskEl.dataset.task;if(confirm('Delete todo?')){await apiDeleteItem(tid);render();}return;}
});

// add item
wrap.addEventListener('submit',async e=>{
  if(!e.target.matches('form[data-act="add-item"]'))return;
  e.preventDefault();
  const gid=parseInt(e.target.closest('.group').dataset.id||'0',10);
  const text=e.target.text.value.trim();
  if(!text)return;
  await apiCreateItem(gid,text);
  e.target.reset();
  render();
});

// filter + keybind
search.addEventListener('input', ()=> render());
document.addEventListener('keydown', e=>{ if(e.key==='/' && document.activeElement!==search){ e.preventDefault(); search.focus(); }});

// first render
render();
</script>
</body>
</html>
